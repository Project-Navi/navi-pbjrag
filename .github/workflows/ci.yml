name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run tests
        run: pytest tests/ -v --cov=pbjrag --cov-report=xml --cov-report=term

      - name: Run linting
        run: ruff check src/

      - name: Type check
        run: mypy src/pbjrag --ignore-missing-imports

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        if: matrix.python-version == '3.12'
        with:
          format: cyclonedx-json
          output-file: sbom.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: sbom
          path: sbom.json

  performance:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run performance tests
        run: |
          pytest tests/test_performance_slo.py -v --tb=short

      - name: Verify SLO compliance
        run: |
          python -c "
          import yaml
          import sys

          # Load SLO definitions
          with open('slo.yaml') as f:
              slos = yaml.safe_load(f)

          # Verify all required SLOs are defined
          required = ['analysis_latency', 'availability', 'error_rate']
          defined = list(slos.get('slos', {}).keys())

          missing = [r for r in required if r not in defined]
          if missing:
              print(f'Missing required SLOs: {missing}')
              sys.exit(1)

          # Verify rollback triggers exist
          if not slos.get('rollback_triggers'):
              print('No rollback triggers defined')
              sys.exit(1)

          print('SLO compliance verified')
          print(f'Defined SLOs: {defined}')
          print(f'Rollback triggers: {len(slos[\"rollback_triggers\"])}')
          "

      - name: Performance budget enforcement
        run: |
          python -c "
          import time
          import sys
          sys.path.insert(0, 'src')

          from pbjrag import DSCAnalyzer, DSCCodeChunker

          # Performance budget: analysis must complete in <5s for small code
          test_code = '''
          def hello_world():
              print('Hello, World!')

          class Calculator:
              def add(self, a, b):
                  return a + b
          '''

          start = time.perf_counter()

          chunker = DSCCodeChunker()
          chunks = chunker.chunk_code(test_code)

          analyzer = DSCAnalyzer()
          for chunk in chunks:
              analyzer.analyze_chunk(chunk)

          elapsed = time.perf_counter() - start

          # Budget: 5 seconds max for small code analysis
          budget_ms = 5000
          elapsed_ms = elapsed * 1000

          print(f'Analysis completed in {elapsed_ms:.2f}ms')
          print(f'Budget: {budget_ms}ms')

          if elapsed_ms > budget_ms:
              print(f'FAIL: Exceeded performance budget by {elapsed_ms - budget_ms:.2f}ms')
              sys.exit(1)
          else:
              print(f'PASS: Under budget by {budget_ms - elapsed_ms:.2f}ms')
          "

  dependency-audit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Verify dependency allow/deny lists
        run: |
          python -c "
          import yaml
          import sys

          # Load dependency policy
          with open('dependencies.yaml') as f:
              policy = yaml.safe_load(f)

          # Verify structure
          if 'allowed' not in policy:
              print('ERROR: No allowed dependencies defined')
              sys.exit(1)

          if 'denied' not in policy:
              print('ERROR: No denied dependencies defined')
              sys.exit(1)

          # Count policies
          allowed_count = sum(len(v) for v in policy['allowed'].values())
          denied_count = len(policy['denied'])

          print(f'Dependency policy loaded:')
          print(f'  Allowed: {allowed_count} packages')
          print(f'  Denied: {denied_count} packages/patterns')
          print(f'  Version: {policy.get(\"version\", \"unknown\")}')
          print(f'  Last reviewed: {policy.get(\"last_reviewed\", \"unknown\")}')

          # Verify audit config
          audit = policy.get('audit', {})
          if not audit.get('fail_on_violation', False):
              print('WARNING: Audit not configured to fail on violation')

          print('Dependency policy validation: PASS')
          "
