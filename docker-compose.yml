version: '3.8'

services:
  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: pbjrag-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - pbjrag-network
    restart: unless-stopped

  # PBJRAG Streamlit WebUI
  webui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pbjrag-webui
    ports:
      - "8501:8501"
    volumes:
      - ./webui:/app/webui
      - ./src:/app/src
      - ./examples:/app/examples
      - uploaded_codebases:/app/uploads
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - PYTHONPATH=/app
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - pbjrag-network
    restart: unless-stopped
    stdin_open: true
    tty: true

volumes:
  qdrant_storage:
    driver: local
  uploaded_codebases:
    driver: local

networks:
  pbjrag-network:
    driver: bridge
