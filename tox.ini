# Tox configuration for PBJRAG
# Multi-environment testing for Python 3.10, 3.11, 3.12

[tox]
envlist = py310,py311,py312,lint,coverage
isolated_build = True
skip_missing_interpreters = True

[testenv]
description = Run unit tests with pytest
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.1
    numpy>=1.24.0
    requests>=2.28.0
commands =
    pytest {posargs:tests/}

[testenv:py310]
description = Test with Python 3.10
basepython = python3.10

[testenv:py311]
description = Test with Python 3.11
basepython = python3.11

[testenv:py312]
description = Test with Python 3.12
basepython = python3.12

[testenv:lint]
description = Run code quality checks
deps =
    ruff>=0.1.0
    black>=23.0.0
    mypy>=1.5.0
    pylint>=3.0.0
skip_install = True
commands =
    ruff check src/ tests/
    black --check src/ tests/
    mypy src/pbjrag
    pylint src/pbjrag

[testenv:format]
description = Auto-format code
deps =
    ruff>=0.1.0
    black>=23.0.0
skip_install = True
commands =
    ruff check --fix src/ tests/
    black src/ tests/

[testenv:coverage]
description = Run tests with coverage reporting
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.1
    numpy>=1.24.0
    requests>=2.28.0
commands =
    pytest --cov=pbjrag --cov-report=html --cov-report=term --cov-report=xml --cov-branch {posargs:tests/}
    python -c "print('\n=== Coverage Report ===')"
    python -c "import sys; from pathlib import Path; p = Path('htmlcov/index.html'); print(f'HTML Report: {p.absolute()}') if p.exists() else None"

[testenv:coverage-report]
description = Generate and display coverage report
deps =
    coverage[toml]>=7.0.0
skip_install = True
commands =
    coverage report --show-missing
    coverage html
    python -c "from pathlib import Path; print(f'\nHTML coverage report: {Path(\"htmlcov/index.html\").absolute()}')"

[testenv:integration]
description = Run integration tests only
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.1
    numpy>=1.24.0
    requests>=2.28.0
commands =
    pytest -v -m integration {posargs:tests/test_integration.py}

[testenv:unit]
description = Run unit tests only (exclude integration)
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.1
    numpy>=1.24.0
    requests>=2.28.0
commands =
    pytest -v -m "not integration" {posargs:tests/}

[testenv:quick]
description = Quick test run (unit tests only, no coverage)
deps =
    pytest>=7.4.0
    numpy>=1.24.0
    requests>=2.28.0
commands =
    pytest -v -m "not integration" --tb=short {posargs:tests/}

[testenv:docs]
description = Build documentation
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=1.3.0
changedir = docs
commands =
    sphinx-build -b html . _build/html

[testenv:clean]
description = Clean up build artifacts
deps =
skip_install = True
allowlist_externals =
    rm
    find
commands =
    python -c "import shutil; import os; [shutil.rmtree(d, ignore_errors=True) for d in ['.pytest_cache', '.coverage', 'htmlcov', '.mypy_cache', '.ruff_cache', 'dist', 'build', '*.egg-info']]"
    python -c "import pathlib; [p.unlink() for p in pathlib.Path('.').rglob('*.pyc')]"
    python -c "import pathlib; [p.unlink() for p in pathlib.Path('.').rglob('.coverage.*')]"

[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -v
    --strict-markers
    --tb=short
    --disable-warnings
markers =
    integration: Integration tests (slower, end-to-end)
    unit: Unit tests (fast, isolated)
    slow: Slow running tests

[coverage:run]
source = src/pbjrag
branch = True
omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */site-packages/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod
    @abc.abstractmethod

[coverage:html]
directory = htmlcov

[coverage:xml]
output = coverage.xml
